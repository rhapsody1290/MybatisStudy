
<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 18 一月 2014 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Eduardo Macarron" />
    <meta name="Date-Revision-yyyymmdd" content="20140118" />
    <meta http-equiv="Content-Language" content="zh" />
    <title>MyBatis - 
    MyBatis-Spring | Sample Code</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>MyBatis-Spring</h2>
                </div>
                      </div>
        <div class="pull-right">                                <a href="../../" id="bannerRight" title="MyBatis logo">
                                                                                        <img src="./images/mybatis-logo.png"  alt="MyBatis logo"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">最近更新: 18 一月 2014
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">版本: 1.2.2
                      </li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Reference Documentation</li>
                              
      <li>
  
                          <a href="index.html" title="简介">
          <i class="none"></i>
        简介</a>
            </li>
                
      <li>
  
                          <a href="getting-started.html" title="第二章 入门">
          <i class="none"></i>
        第二章 入门</a>
            </li>
                
      <li>
  
                          <a href="factorybean.html" title="SqlSessionFactoryBean">
          <i class="none"></i>
        SqlSessionFactoryBean</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="transactions.html" title="第四章 事务">
          <i class="icon-chevron-right"></i>
        第四章 事务</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="sqlsession.html" title="第五章 使用 SqlSession">
          <i class="icon-chevron-right"></i>
        第五章 使用 SqlSession</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="mappers.html" title="第六章 注入映射器">
          <i class="icon-chevron-right"></i>
        第六章 注入映射器</a>
                  </li>
                
      <li>
  
                          <a href="using-api.html" title="第七章 使用 MyBatis API">
          <i class="none"></i>
        第七章 使用 MyBatis API</a>
            </li>
                
      <li class="active">
  
            <a href="#"><i class="none"></i>第八章 示例代码</a>
          </li>
                              <li class="nav-header">项目文档</li>
                                                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-info.html" title="项目信息">
          <i class="icon-chevron-right"></i>
        项目信息</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-reports.html" title="项目报表">
          <i class="icon-chevron-right"></i>
        项目报表</a>
                  </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="构建依靠 Maven" class="poweredBy">
        <img class="builtBy" alt="构建依靠 Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <!-- Copyright 2010-2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. --><!-- version: $Id$ -->

  
    <div class="section">
<h2>Sample Code<a name="Sample_Code"></a></h2>
      
<p>
      	JPetStore 6 is a full web application built on top of MyBatis 3,
      	<a class="externalLink" href="http://www.springsource.org">Spring 3</a> and <a class="externalLink" href="http://www.stripesframework.org/">Stripes</a>.
        It is available for downloading in the
        <a class="externalLink" href="https://github.com/mybatis/jpetstore-6/releases">downloads</a>
        section of MyBatis project site.
        In this section we will walk through this sample to understand how is it built and learn how to run it.
      </p>
      
<div class="section">
<h3>Purpose<a name="Purpose"></a></h3>
      	
<p>
      	This new JPetStore comes with the same idea in mind than its predecessors: <b>keep it simple</b>. 
      	The purpose of JPetStore 6 is to demonstrate how to build a web application with very few classes and no advanced coding skills. 
      	You just need to know plain Java and SQL.
      	</p>
      	
<p>
      	The 6th version of JPetStore is the smallest one in the family. 
      	It uses just 24 java classes while keeping a good design and program structure.
      	As we will see later on, you will find no code for dealing with JDBC, for creating objects or bind them or to handle transactions. 
      	What is more impressive is that you <b>will not find any call to the MyBatis API</b>. 
      	Although this sounds magical, you will see that the combination of MyBatis mappers and dependency injection lets you 
      	build applications without dependencies.
      	</p>
      </div>
      
<div class="section">
<h3>Program Structure<a name="Program_Structure"></a></h3>
      	
<p> JPetStore 6 follows the typical maven project structure </p>

<div>
<pre>/jpetstore                    <tt>&lt;-- Maven pom.xml goes here.</tt>
  /src
    /main/
      /java                   <tt>&lt;-- Java code goes here.</tt>
        /org/
          /mybatis
            /jpetstore
              /domain         <tt>&lt;-- Business domain objects go here.</tt>
              /persistence    <tt>&lt;-- Mapper interfaces go here.</tt>
              /service        <tt>&lt;-- Application logic goes here.</tt>
              /web
                /actions      <tt>&lt;-- Presentation logic (actions) goes here.</tt>
      /resources              <tt>&lt;-- Non java files go here.</tt>
        /org
          /mybatis
            /jpetstore
              /persistence    <tt>&lt;-- Mapper XML files go here.</tt>
        /database
      /webapp
        /css
        /images
        /WEB-INF              <tt>&lt;-- web.xml and applicationContext.xml go here.</tt>
          /jsp                <tt>&lt;-- JSP files go here.</tt>
      </pre></div>
      </div>

      
<div class="section">
<h3>Configuration files<a name="Configuration_files"></a></h3>
      
<p>
      Configuration files are read during application startup. Their purpose is to configure the three
      frameworks composing the application: Stripes, Spring and MyBatis. We will just need to configure
      two files: web.xml and applicationContext.xml.
      </p>
      
<div class="section">
<h4>web.xml<a name="web.xml"></a></h4>
      
<p>
      First of all we need to start Stripes, so we follow the Stripes manual to do so. The manual says that
      we should set up a dispatcher servlet and a filter. So let's go.
      </p>

<div class="source">
<pre>
&lt;filter&gt;
  &lt;display-name&gt;Stripes Filter&lt;/display-name&gt;
  &lt;filter-name&gt;StripesFilter&lt;/filter-name&gt;
  &lt;filter-class&gt;net.sourceforge.stripes.controller.StripesFilter&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
  &lt;filter-name&gt;StripesFilter&lt;/filter-name&gt;
  &lt;servlet-name&gt;StripesDispatcher&lt;/servlet-name&gt;
  &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt;
&lt;/filter-mapping&gt;
&lt;servlet&gt;
  &lt;servlet-name&gt;StripesDispatcher&lt;/servlet-name&gt;
  &lt;servlet-class&gt;net.sourceforge.stripes.controller.DispatcherServlet&lt;/servlet-class&gt;
  &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;StripesDispatcher&lt;/servlet-name&gt;
  &lt;url-pattern&gt;*.action&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</pre></div>

	
<p>Stripes is able to search for ActionBean classes, for that purpose we must set up the
	base package it should search in.</p>


<div class="source">
<pre>
&lt;filter-class&gt;net.sourceforge.stripes.controller.StripesFilter&lt;/filter-class&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;ActionResolver.Packages&lt;/param-name&gt;
    &lt;param-value&gt;org.mybatis.jpetstore.web&lt;/param-value&gt;
  &lt;/init-param&gt;
&lt;/filter&gt;
</pre></div>

	
<p>We are done with Stripes. Let's move on to the Spring side. According to Spring's reference manual
	we should add a Context listener to start up Spring. So let's add it:</p>


<div class="source">
<pre>
&lt;listener&gt;
  &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;
</pre></div>

	
<p>By default Spring will use <tt>/WEB-INF/applicationContext.xml</tt> if we don't specify
	a different file. The default is fine for us.
	</p>

	
<p>Now we have to let Stripes know that it will be running with Spring. This way we will be able
	to inject Spring beans directly into Stripes ActionBeans. For that purpose, following once
	again the Stripes manual, we set up an interceptor as follows below:
	</p>


<div class="source">
<pre>
&lt;filter-class&gt;net.sourceforge.stripes.controller.StripesFilter&lt;/filter-class&gt;
  ...
  &lt;init-param&gt;
    &lt;param-name&gt;Interceptor.Classes&lt;/param-name&gt;
    &lt;param-value&gt;net.sourceforge.stripes.integration.spring.SpringInterceptor&lt;/param-value&gt;
  &lt;/init-param&gt;
&lt;/filter&gt;
</pre></div>

      
<p>We are done with web.xml. As you may have notice, we have not set up any MyBatis 3 configuration yet.
      That configuration goes into the Spring's applicationContext.xml that we will see in the following
      section.
      </p>

      </div>
<div class="section">
<h4>applicationContext.xml<a name="applicationContext.xml"></a></h4>
      
<p>As you already know applicationContext.xml is the Spring's configuration file. Spring is a dependency
      injection framework and it has to know which beans it must create and how to bind them together and that is
      what applicationContext.xml file is for. Let's have a deeper look into it.
      </p>
      
<p>
      The first and easiest thing we have to do is let Spring know where are our service beans. We will let Spring
      search them in our classpath so we just need to provide it the base package to search in:
      </p>


<div class="source">
<pre>
&lt;context:component-scan base-package=&quot;org.mybatis.jpetstore.service&quot; /&gt;
</pre></div>

	  
<p>
	  <span class="label important">NOTE</span> Spring's component scan feature is not able to find MyBatis mappers.
	  A mapper is not a plain bean and Spring would not know how to instantiate it. We will see how to search for
	  mappers soon.
	  </p>

	  
<p>We will also need a <tt>DataSource</tt> and a <tt>TransactionManager</tt>. Given that this is a demo application
	  we will use a test Spring <tt>DataSource</tt> that will create an HSQL in-memory database and load
	  our database scripts into it and the standard Spring's <tt>DataSourceTransactionManager</tt>
	  to handle transactions.
	  </p>


<div class="source">
<pre>
&lt;jdbc:embedded-database id=&quot;dataSource&quot;&gt;
  &lt;jdbc:script location=&quot;classpath:database/jpetstore-hsqldb-schema.sql&quot;/&gt;
  &lt;jdbc:script location=&quot;classpath:database/jpetstore-hsqldb-dataload.sql&quot;/&gt;
&lt;/jdbc:embedded-database&gt;

&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
  &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
&lt;/bean&gt;
</pre></div>

	  
<p>So far, all we have done is standard Stripes and Spring configuration and now it is time to
	  move on to the MyBatis part. As you have learned in this manual to set up MyBatis with Spring you need
	  at least two things: an <tt>SqlSessionFactoryBean</tt> and a mapper class. So let's go hands on.
	  First define a <tt>SqlSessionFactoryBean</tt>:
	  </p>


<div class="source">
<pre>
&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;
  &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
&lt;/bean&gt;
</pre></div>

      
<p>And now we need to setup our mappers. For that purpose we will use the <tt>MapperScannerConfigurer</tt>
      that works similar to Spring standard component scan. It will search our classpath for mapper classes
      and register them to MyBatis. Similar to Spring's component scan we must configure the base
      package to search in.
      </p>


<div class="source">
<pre>
&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;
  &lt;property name=&quot;basePackage&quot; value=&quot;org.mybatis.jpetstore.persistence&quot; /&gt;
&lt;/bean&gt;
</pre></div>

      
<p>To save some writing when building our mapper xml files we would want to be able to use short
      aliases for beans. The <tt>SqlSessionFactoryBean</tt> has the capability to search for beans and
      register their short names as aliases if we setup the <tt>typeAliasPackage</tt> property like
      the following:
      </p>


<div class="source">
<pre>
&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;
  &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
  &lt;property name=&quot;typeAliasesPackage&quot; value=&quot;org.mybatis.jpetstore.domain&quot; /&gt;
&lt;/bean&gt;
</pre></div>

		
<p>Our application is now fully configured and ready to run. But before running it lets have a tour
		through the code to see how it looks like.
		</p>

      </div></div>

      
<div class="section">
<h3>Code tour<a name="Code_tour"></a></h3>
      
<p>JPetStore 6 is a typical MVC application with three layers: presentation, logic and data access.
      </p>
      
<div class="section">
<h4>Presentation<a name="Presentation"></a></h4>
      
<p>The presentation layer is composed by JSP files and Stripes ActionBeans. JSPs just use plain HTML,
      JSTL tags and Stripes tags so there is nothing especial about them for the sake of this sample. Stripes
      ActionBeans are like Struts actions or Spring MVC controllers so there is nothing especial with them either.
      </p>
      
<p>Given that we have integrated Stripes with Spring, we can inject our services into our ActionsBeans so
      you can just use them without caring about its creation or lookup.
      Have a look at <tt>CatalogActionBean</tt>:
      </p>


<div class="source">
<pre>
@SessionScope
public class CatalogActionBean extends AbstractActionBean {
  ...
  @SpringBean
  private transient CatalogService catalogService;
  ...
  public ForwardResolution viewCategory() {
    if (categoryId != null) {
      productList = catalogService.getProductListByCategory(categoryId);
      category = catalogService.getCategory(categoryId);
    }
    return new ForwardResolution(VIEW_CATEGORY);
  }
  ...
</pre></div>

	  
<p>Note the <tt>@SpringBean</tt> annotation, that is an Stripes annotation that tells Stripes to
	  look for that bean in Spring and inject it into this ActionBean.</p>

      </div>
<div class="section">
<h4>Logic<a name="Logic"></a></h4>
      
<p>Application logic is composed by plain Java beans that act as services and plain Java beans that
      act as domain objects. This layer is in charge of filling domain objects with database data and
      updating database data with the content of the domain objects. For this purpose this layer must be
      transactional, that is, it must be able to perform atomic database updates.
      </p>
      
<p>Let's have a look at <tt>OrderService</tt> code to see how all this is achieved:
      </p>


<div class="source">
<pre>
@Service
public class OrderService {

  @Autowired
  private ItemMapper itemMapper;
  @Autowired
  private OrderMapper orderMapper;
  @Autowired
  private LineItemMapper lineItemMapper;

  @Transactional
  public void insertOrder(Order order) {
    order.setOrderId(getNextId(&quot;ordernum&quot;));
    for (int i = 0; i &lt; order.getLineItems().size(); i++) {
      LineItem lineItem = (LineItem) order.getLineItems().get(i);
      String itemId = lineItem.getItemId();
      Integer increment = new Integer(lineItem.getQuantity());
      Map&lt;String, Object&gt; param = new HashMap&lt;String, Object&gt;(2);
      param.put(&quot;itemId&quot;, itemId);
      param.put(&quot;increment&quot;, increment);
      itemMapper.updateInventoryQuantity(param);
    }

    orderMapper.insertOrder(order);
    orderMapper.insertOrderStatus(order);
    for (int i = 0; i &lt; order.getLineItems().size(); i++) {
      LineItem lineItem = (LineItem) order.getLineItems().get(i);
      lineItem.setOrderId(order.getOrderId());
      lineItemMapper.insertLineItem(lineItem);
    }
  }
</pre></div>

      
<p>The first thing you will notice is that there is no JDBC code in the service,
      nor it is any MyBatis code in it. You may think that we used the
      DAO pattern and database access code is in the database layer, but as we will see later,
      the database layer is built with MyBatis mappers, that are plain java
      interfaces, and that is why <b>you will not find any call to MyBatis API</b>
      in the whole application. It is just not needed.</p>

      
<p>The second thing you may have noticed is that there are no commits or rollbacks.
      That is because it uses the declarative transaction demarcation feature of Spring that is
      fully supported by MyBatis-Spring.
      The Spring's <tt>@Transactional</tt> annotation indicates that this method is transactional,
      that means that all <tt>updateInventoryQuantity</tt>, <tt>insertOrder</tt> and
      <tt>insertLineItem</tt> mapper calls must succeed or none.</p>

      </div>
<div class="section">
<h4>Persistence<a name="Persistence"></a></h4>
      
<p>The persistence layer is composed of MyBatis mappers. Mappers are just plain Java
      interfaces and mapper XML files containing the SQL statements.
      There is no custom Java code in this layer. When the
      <tt>getOrder</tt> method is called on the <tt>OrderMapper</tt> interface,
      MyBatis will execute the getOrder SQL statement in OrderMapper.xml file and
      will populate the <tt>Order</tt> domain bean with retrieved data.
      </p>


<div class="source">
<pre>
public interface OrderMapper {
  List&lt;Order&gt; getOrdersByUsername(String username);
  Order getOrder(int orderId);
  void insertOrder(Order order);
  void insertOrderStatus(Order order);
}</pre></div>


<div class="source">
<pre>
&lt;mapper namespace=&quot;org.mybatis.jpetstore.persistence.OrderMapper&quot;&gt;

  &lt;cache /&gt;

  &lt;select id=&quot;getOrder&quot; resultType=&quot;Order&quot; parameterType=&quot;int&quot;&gt;
    SELECT
      BILLADDR1 AS billAddress1,
      BILLADDR2 AS billAddress2,
      BILLCITY,
      BILLCOUNTRY,
      BILLSTATE,
      BILLTOFIRSTNAME,
      BILLTOLASTNAME,
      BILLZIP,
      SHIPADDR1 AS shipAddress1,
      SHIPADDR2 AS shipAddress2,
      SHIPCITY,
      SHIPCOUNTRY,
      SHIPSTATE,
      SHIPTOFIRSTNAME,
      SHIPTOLASTNAME,
      SHIPZIP,
      CARDTYPE,
      COURIER,
      CREDITCARD,
      EXPRDATE AS expiryDate,
      LOCALE,
      ORDERDATE,
      ORDERS.ORDERID,
      TOTALPRICE,
      USERID AS username,
      STATUS
    FROM ORDERS, ORDERSTATUS
    WHERE ORDERS.ORDERID = #{value}
      AND ORDERS.ORDERID = ORDERSTATUS.ORDERID
  &lt;/select&gt;
  ...
&lt;/mapper&gt;
</pre></div>

      
<p>
      <span class="label important">NOTE</span>
      You can easily add caching to your queries by adding a &lt;cache /&gt; element to your
      mapper xml file. Or, if you prefer, Spring lets you cache at a higher level, caching the
      whole call to a mapper or service method.
      </p>

      </div></div>

      
<div class="section">
<h3>Running JPetStore<a name="Running_JPetStore"></a></h3>
        
<p>You may ask. Does all this work? Yes it does! Let's run it.</p>
        
<p>Let's assume you have a clean computer. These are the steps you should follow to
      have the sample running on Tomcat with Eclipse:
        </p>
        
<ul>
          
<li>Download and install a JDK 6 or later</li>
          
<li>Download and upzip Eclipse</li>
          
<li>Download and unzip Tomcat</li>
          
<li>Run Eclipse</li>
          
<li>Go to Git tab</li>
          
<li>Clone the repo https://github.com/mybatis/jpetstore-6.git</li>
          
<li>Select working directory, right click and select Import Projects (general)</li>
          
<li>Go to Java EE tab</li>
          
<li>Right click on jpetstore project and select &quot;Configure/Convert to Maven Project&quot;</li>
          
<li>Right click on jpetstore project and select &quot;run on server&quot;</li>
          
<li>Select Tomcat Server and set your installation directory</li>
          
<li>JPetStore home page should be shown!!</li>
        </ul>
        
<p>
          Now you are ready to play with it, experiment with your own changes or whatever you want.
        </p>
        
<p>
          And remember that if you find a bug or something that is missing or can be improved (for example the missing tests!),
          fork the repo, change it, and open a pull request. Thanks in advance!!!
        </p>
        
<p>
          <span class="label important">NOTE</span>
		JPetStore 6 should run in any Servlet 2.5 y JSP 2.1 compliant Java server. Eclipse is not needed
		either, you can run the sample from your favorite IDE or the command line.
        </p>
      </div>
    </div>
  

                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2010&#x2013;2014
                        <a href="http://www.mybatis.org/">MyBatis.org</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
